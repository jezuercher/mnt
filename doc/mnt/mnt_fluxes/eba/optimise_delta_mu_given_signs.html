<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of optimise_delta_mu_given_signs</title>
  <meta name="keywords" content="optimise_delta_mu_given_signs">
  <meta name="description" content="delta_mu = optimize_delta_mu_given_signs(N,parameter_prior,data,v,options)">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../index.html">Home</a> &gt;  <a href="#">mnt</a> &gt; <a href="#">mnt_fluxes</a> &gt; <a href="#">eba</a> &gt; optimise_delta_mu_given_signs.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../index.html"><img alt="<" border="0" src="../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for ./mnt/mnt_fluxes/eba&nbsp;<img alt=">" border="0" src="../../../right.png"></a></td></tr></table>-->

<h1>optimise_delta_mu_given_signs
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>delta_mu = optimize_delta_mu_given_signs(N,parameter_prior,data,v,options)</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function [delta_mu, delta_mu_ind_score] = optimize_delta_mu_given_signs(N,parameter_prior,data,v,options) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment">delta_mu = optimize_delta_mu_given_signs(N,parameter_prior,data,v,options)

 maximise prob density w.r.t. delta_mu
 (with distribution parameters mean: delta_mu_mean and covariance: delta_mu_cov)
 while satisfying the sign constraints v~=0 -&gt; sign(delta_mu) = -sign(v)

 v: (size nr x n_exp) flux matrix, only used for sign constraints</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../.././mnt/mnt_mca/analyse_N.html" class="code" title="function [K, L, NR, null_l, pinv_NR, independent_metabolites, N1] = analyse_N(N,external)">analyse_N</a>	[ K, L, NR, null_l, pinv_NR, independent_metabolites, N1] = analyse_N(N,external)</li><li><a href="../../.././mnt/mnt_numbers/RT.html" class="code" title="function result = RT(temperature)">RT</a>	result = RT(temperature)</li><li><a href="../../.././mnt/utils/matrix_add_block.html" class="code" title="function M = matrix_add_block(A,B);">matrix_add_block</a>	M = matrix_add_block(A,B);</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
</ul>
<!-- crossreference -->


<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [delta_mu, delta_mu_ind_score] = optimize_delta_mu_given_signs(N,parameter_prior,data,v,options)</a>
0002 
0003 <span class="comment">%delta_mu = optimize_delta_mu_given_signs(N,parameter_prior,data,v,options)</span>
0004 <span class="comment">%</span>
0005 <span class="comment">% maximise prob density w.r.t. delta_mu</span>
0006 <span class="comment">% (with distribution parameters mean: delta_mu_mean and covariance: delta_mu_cov)</span>
0007 <span class="comment">% while satisfying the sign constraints v~=0 -&gt; sign(delta_mu) = -sign(v)</span>
0008 <span class="comment">%</span>
0009 <span class="comment">% v: (size nr x n_exp) flux matrix, only used for sign constraints</span>
0010 
0011 [nm,nr] = size(N);
0012 n_exp   = size(v,2);
0013 
0014 is isfield(data,<span class="string">'delta_mu'</span>), delta_mu_data = data.dmu; <span class="keyword">end</span>
0015 
0016 
0017 <span class="comment">%------------------------------------------------------------------</span>
0018 <span class="comment">% requested signs of delta_mu  as a (nr x n_exp) matrix</span>
0019 
0020 delta_mu_signs = - sign(v); 
0021 delta_mu_signs = reshape(delta_mu_signs,nr*n_exp,1);
0022 
0023 <span class="comment">% use combined vector b = [mu0; log_c];</span>
0024 
0025 b_mean = [parameter_prior.mu0.mean; reshape(data.log_c.mean,nm*n_exp,1)];
0026 b_cov  = <a href="../../.././mnt/utils/matrix_add_block.html" class="code" title="function M = matrix_add_block(A,B);">matrix_add_block</a>(parameter_prior.mu0.cov,diag(reshape(data.log_c.std,nm*n_exp,1).^2));
0027 
0028 <span class="comment">% set delta_mu = L * delta_mu_ind</span>
0029 <span class="comment">% delta_mu_ind follows a multivariate gaussian with</span>
0030 <span class="comment">% parameters delta_mu_ind_mean, delta_mu_ind_cov</span>
0031 
0032 <span class="comment">% build matrix M_ind such that delta_mu_ind = M_ind * b;</span>
0033 <span class="comment">% NRt contains the independent rows of N'</span>
0034 <span class="comment">% example 3 exp. samples:</span>
0035 <span class="comment">%</span>
0036 <span class="comment">%         ( NRt  RT*NRt   -      -    )</span>
0037 <span class="comment">% M_ind = ( NRt    -    RT*NRt   -    )</span>
0038 <span class="comment">%         ( NRt    -      -    RT*NRt )</span>
0039 
0040 [dum, L, NRt] = <a href="../../.././mnt/mnt_mca/analyse_N.html" class="code" title="function [K, L, NR, null_l, pinv_NR, independent_metabolites, N1] = analyse_N(N,external)">analyse_N</a>(N');
0041 dum = []; <span class="keyword">for</span> it = 1:n_exp, dum = <a href="../../.././mnt/utils/matrix_add_block.html" class="code" title="function M = matrix_add_block(A,B);">matrix_add_block</a>(dum,<a href="../../.././mnt/mnt_numbers/RT.html" class="code" title="function result = RT(temperature)">RT</a>*NRt); <span class="keyword">end</span>
0042 M_ind = [repmat(NRt,n_exp,1), dum];
0043 
0044 <span class="comment">% define the matrix LL such that delta_mu = LL * delta_mu_ind</span>
0045 
0046 LL  = []; <span class="keyword">for</span> it = 1:n_exp, LL = <a href="../../.././mnt/utils/matrix_add_block.html" class="code" title="function M = matrix_add_block(A,B);">matrix_add_block</a>(LL,L); <span class="keyword">end</span>
0047 
0048 <span class="comment">% ------------------------------------------------------------</span>
0049 <span class="comment">% mean and covariance according to knowledge about mu0 and log c</span>
0050 
0051 delta_mu_ind_mean1 = M_ind * b_mean;
0052 delta_mu_ind_cov1  = full(M_ind * b_cov * M_ind');
0053 
0054 
0055 <span class="comment">% ------------------------------------------------------------</span>
0056 <span class="comment">% effective mean and covariance (computed as posterior, treating knowledge about mu0 and log c</span>
0057 <span class="comment">% as prior and knowledge about mu for the likelihood</span>
0058 
0059 this_delta_mu_mean     = reshape(delta_mu_data.mean,nr*n_exp,1);
0060 this_delta_mu_cov_inv  = diag(1./ reshape(delta_mu_data.std,nr*n_exp,1).^2);
0061 Lm                     = LL;
0062 ind_ok                 = find(isfinite(this_delta_mu_mean));
0063 this_delta_mu_mean     = this_delta_mu_mean(ind_ok);
0064 this_delta_mu_cov_inv  = this_delta_mu_cov_inv(ind_ok,ind_ok);
0065 Lm                     = Lm(ind_ok,:);
0066 
0067 [delta_mu_ind_mean, delta_mu_ind_cov_inv] = bayesian_linear_model(Lm,delta_mu_ind_mean1,inv(delta_mu_ind_cov1),this_delta_mu_mean,this_delta_mu_cov_inv);
0068 
0069 <span class="comment">% the sign constraint sign(delta_mu) = delta_mu_signs</span>
0070 <span class="comment">% is formulated as options.epsilon_delta_mu &lt; delta_mu_signs * LL * delta_mu_ind = LLL * delta_mu_ind</span>
0071 <span class="comment">% (rows for unspecified signs because of (v_r = 0) are removed in LLL)</span>
0072 <span class="comment">%</span>
0073 <span class="comment">% in addition, we require that  LLL * delta_mu_ind &lt; options.max_delta_mu</span>
0074 <span class="comment">% (upper limit on all absolute values of delta_mu)</span>
0075 
0076 rel_signs   = find(delta_mu_signs~=0);
0077 irrel_signs = find(~isfinite(delta_mu_signs));
0078 LLL         = diag(delta_mu_signs(rel_signs)) * LL(rel_signs,:);
0079 
0080 A    = full( [-LLL;  LLL; -LL(irrel_signs,:); LL(irrel_signs,:) ]);
0081 xmax = options.max_delta_mu;
0082 b    = [-options.epsilon_delta_mu * ones(size(LLL,1),1); <span class="keyword">...</span>
0083          xmax * ones(size(LLL,1),1); 
0084         -xmax * ones(length(irrel_signs),1);
0085          xmax * ones(length(irrel_signs),1);]; 
0086 
0087 
0088 H = delta_mu_ind_cov_inv;
0089 <span class="comment">% epsilon_reg = 0.0001 * max(eig(H)); % regularisation!!!</span>
0090 <span class="comment">% H = H + epsilon_reg * eye(size(H,1));</span>
0091 H = 1/2*(H+H');
0092 f = - H * delta_mu_ind_mean;
0093 n_mu_ind = length(f);
0094 x_upper = xmax * ones(n_mu_ind,1);
0095 
0096 opt = optimset; opt.MaxIter = 10000; opt.LargeScale = <span class="string">'off'</span>;
0097 
0098 [delta_mu_ind,fval,exitflag] = quadprog(H,f,A,b,[],[], -x_upper, x_upper, delta_mu_ind_mean, opt);
0099 
0100 delta_mu_ind_score = gaussian_score(delta_mu_ind,delta_mu_ind_mean, inv(delta_mu_ind_cov_inv));
0101 
0102 delta_mu = LL * delta_mu_ind;
0103 delta_mu = reshape(delta_mu,nr,n_exp);</pre></div>
<hr><address>Generated on Sat 15-Nov-2014 18:05:26 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>