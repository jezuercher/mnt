<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of project_fluxes</title>
  <meta name="keywords" content="project_fluxes">
  <meta name="description" content="v_projected = project_fluxes(N,ind_ext, v_mean, v_std, v_sign, pars);">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../index.html">Home</a> &gt;  <a href="../../index.html">mnt</a> &gt; <a href="../index.html">mnt_fluxes</a> &gt; <a href="index.html">flux_projection</a> &gt; project_fluxes.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../index.html"><img alt="<" border="0" src="../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for mnt/mnt_fluxes/flux_projection&nbsp;<img alt=">" border="0" src="../../../right.png"></a></td></tr></table>-->

<h1>project_fluxes
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>v_projected = project_fluxes(N,ind_ext, v_mean, v_std, v_sign, pars);</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function v_projected = project_fluxes(N, ind_ext, v_mean, v_std, v_sign, pars); </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> v_projected = project_fluxes(N,ind_ext, v_mean, v_std, v_sign, pars);

 project fluxes to stationary subspace (different methods)

 pars.method:            'simple', 'one_norm',     'lasso',   'euclidean', 'thermo_correct', 
 pars.remove_eba_cycles: (flag) if set to 1, a matrix pars.C of eba-cycles has to be provided
 option 'thermo_correct' requires par.network</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../mnt/mnt_fluxes/eba/eba_make_feasible.html" class="code" title="function [v,C] = eba_make_feasible(v,N,eba_condition,C,ind_ignore,cycle_method,ind_ext)">eba_make_feasible</a>	v = eba_make_feasible(v,N,eba_condition,C,ind_ignore)</li><li><a href="../../../mnt/mnt_fluxes/eba/feasible_fluxes.html" class="code" title="function [v, C] = feasible_fluxes(N,ind_ext,data,es_constraints,eba_condition,C)">feasible_fluxes</a>	[v, C] = feasible_fluxes(N,ind_ext,data,es_constraints,eba_condition,C)</li><li><a href="../../../mnt/mnt_fluxes/flux_feasibility/eba_feasible.html" class="code" title="function [feasible,C,ind_non_orthogonal] = eba_feasible(v,N,C,ind_ignore,eba_condition,cycle_method)">eba_feasible</a>	[feasible,C,ind_non_orthogonal] = eba_feasible(v,N,C,ind_ignore,eba_condition,cycle_method)</li><li><a href="es_make_fluxes_stationary.html" class="code" title="function v_stationary = es_make_fluxes_stationary(network,v)">es_make_fluxes_stationary</a>	v_stationary = es_make_fluxes_stationary(network,v)</li><li><a href="project_fluxes.html" class="code" title="function v_projected = project_fluxes(N, ind_ext, v_mean, v_std, v_sign, pars);">project_fluxes</a>	v_projected = project_fluxes(N,ind_ext, v_mean, v_std, v_sign, pars);</li><li><a href="../../../mnt/util/default.html" class="code" title="function commandstring = default(varargin)">default</a>	commandstring = default(varname1,defaultvalue1,varname2,defaultvalue2,...)</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../mnt/mnt_fluxes/eba/eba_make_feasible.html" class="code" title="function [v,C] = eba_make_feasible(v,N,eba_condition,C,ind_ignore,cycle_method,ind_ext)">eba_make_feasible</a>	v = eba_make_feasible(v,N,eba_condition,C,ind_ignore)</li><li><a href="flux_least_squares_projection.html" class="code" title="function v = flux_least_squares_projection(network,v_pre)">flux_least_squares_projection</a>	v = flux_least_squares_projection(network,v_pre)</li><li><a href="project_fluxes.html" class="code" title="function v_projected = project_fluxes(N, ind_ext, v_mean, v_std, v_sign, pars);">project_fluxes</a>	v_projected = project_fluxes(N,ind_ext, v_mean, v_std, v_sign, pars);</li><li><a href="../../../mnt/mnt_network/network_build_edit/network_subnetwork_balanced.html" class="code" title="function [network_red,v_red,dmu_red,c_red] = network_subnetwork_balanced(network,v,epsilon,vmin,dmu,c)">network_subnetwork_balanced</a>	[network_red,v_red,dmu_red,c_red] = network_subnetwork_balanced(network,v,epsilon,vmin,dmu,c)</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function v_projected = project_fluxes(N, ind_ext, v_mean, v_std, v_sign, pars);</a>
0002 
0003 <span class="comment">% v_projected = project_fluxes(N,ind_ext, v_mean, v_std, v_sign, pars);</span>
0004 <span class="comment">%</span>
0005 <span class="comment">% project fluxes to stationary subspace (different methods)</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% pars.method:            'simple', 'one_norm',     'lasso',   'euclidean', 'thermo_correct',</span>
0008 <span class="comment">% pars.remove_eba_cycles: (flag) if set to 1, a matrix pars.C of eba-cycles has to be provided</span>
0009 <span class="comment">% option 'thermo_correct' requires par.network</span>
0010 
0011 eval(<a href="../../../mnt/util/default.html" class="code" title="function commandstring = default(varargin)">default</a>(<span class="string">'pars'</span>,<span class="string">'struct'</span>,<span class="string">'v_std'</span>,<span class="string">'[]'</span>,<span class="string">'v_sign'</span>,<span class="string">'[]'</span>));
0012 
0013 <span class="keyword">if</span> size(v_mean,2)&gt;1,
0014   <span class="keyword">for</span> it = 1:size(v_mean,2),
0015     <span class="keyword">if</span> length(v_std), vv1 = v_std(:,it); <span class="keyword">else</span> vv1 = []; <span class="keyword">end</span>
0016     <span class="keyword">if</span> length(v_sign), vv2 = v_sign(:,it); <span class="keyword">else</span> vv2 = []; <span class="keyword">end</span>
0017     v_projected(:,it) = <a href="project_fluxes.html" class="code" title="function v_projected = project_fluxes(N, ind_ext, v_mean, v_std, v_sign, pars);">project_fluxes</a>(N, ind_ext, v_mean(:,it), vv1, vv2, pars);
0018   <span class="keyword">end</span>
0019   <span class="keyword">return</span>
0020 <span class="keyword">end</span>
0021 
0022 default_pars = struct(<span class="string">'method'</span>,<span class="string">'euclidean'</span>,<span class="string">'ind_ignore'</span>,[],<span class="string">'remove_eba_cycles'</span>,0);
0023 pars = join_struct(default_pars,pars);
0024 
0025 <span class="keyword">if</span> isempty(v_std),  v_std  = ones(size(v_mean)); <span class="keyword">end</span> 
0026 <span class="keyword">if</span> isempty(v_sign), v_sign = nan * v_mean; <span class="keyword">end</span> 
0027 
0028 <span class="comment">% make sure that reference fluxes respect zero flux and sign constraints</span>
0029 
0030 v_mean(v_sign == 0 )           = 0;
0031 v_std( v_sign == 0 )           = 0.01 * nanstd(v_mean(:));
0032 v_std( find(v_mean.*v_sign)&lt;0) = nan;
0033 v_mean(find(v_mean.*v_sign)&lt;0) = nan;
0034 
0035 external          = zeros(size(N,1),1); 
0036 external(ind_ext) = 1;
0037 
0038 display(sprintf(<span class="string">'Projecting fluxes using &quot;%s&quot; method'</span>, pars.method));
0039 
0040 <span class="keyword">switch</span> pars.method,
0041 
0042   <span class="keyword">case</span> <span class="string">'simple'</span>,
0043     display(<span class="string">'Simple projection - flux sign constraints are ignored'</span>);
0044     network.N                 = N;
0045     network.external          = zeros(size(N,1),1);
0046     network.external(ind_ext) = 1;
0047     v_projected               = <a href="es_make_fluxes_stationary.html" class="code" title="function v_stationary = es_make_fluxes_stationary(network,v)">es_make_fluxes_stationary</a>(network,v_mean);
0048 
0049   <span class="keyword">case</span> <span class="string">'one_norm'</span>,    
0050     ind_finite        = find(isfinite(v_mean));
0051     [nm,nr] = size(N);
0052     A = N(external == 0,:);
0053     b = zeros(size(A,1),1);
0054     lb = v_mean(ind_finite)-v_std(ind_finite);
0055     ub = v_mean(ind_finite)+v_std(ind_finite);
0056     v_projected = my_lp_one_norm(A,b,lb,ub,100000);
0057 
0058   <span class="keyword">case</span> <span class="string">'lasso'</span>,    <span class="comment">%% lasso regression</span>
0059     ind_finite        = find(isfinite(v_mean));
0060     v_cov_inv         = diag(1./v_std(ind_finite).^2);
0061     <span class="keyword">if</span> exist(<span class="string">'external'</span>,<span class="string">'var'</span>), Nint = N(find(external ==0),:); <span class="keyword">end</span>
0062     K = null(full(Nint));
0063     display(<span class="string">'Running lasso regression, this can take a while'</span>);
0064     rho_mean = lasso(sqrt(v_cov_inv)* K(ind_finite,:),v_mean(ind_finite),0.1,10^-2,10^-1)
0065     v_projected = K * rho_mean;
0066 
0067   <span class="keyword">case</span> <span class="string">'euclidean'</span>, <span class="comment">%% two-norm regression with constraints</span>
0068     ind_finite        = find(isfinite(v_mean));
0069     v_mean            = v_mean(ind_finite);
0070     v_cov_inv         = diag(1./v_std(ind_finite).^2);
0071     [nm,nr] = size(N);
0072     <span class="keyword">if</span> exist(<span class="string">'external'</span>,<span class="string">'var'</span>), Nint = N(find(external ==0),:); <span class="keyword">end</span>
0073     v_sign_finite= v_sign(ind_finite);
0074     ind_nonzeros = find(v_sign_finite~=0);
0075     v_sign_finite= v_sign_finite(ind_nonzeros);
0076     v_cov_inv    = v_cov_inv(ind_nonzeros,ind_nonzeros);
0077     my_v_mean    = v_mean(ind_nonzeros);
0078     ind_finite   = find(isfinite(my_v_mean));
0079     K            = null(full(Nint(:,find(v_sign ~=0 ))));
0080     rho_cov_inv  = K(ind_finite,:)' * v_cov_inv * K(ind_finite,:);
0081     <span class="comment">%% safety measure to prevent unrealistic estimates of non-measured fluxes:</span>
0082     <span class="keyword">if</span> length(rho_cov_inv),
0083       rho_cov_inv  = rho_cov_inv + 10^-5 * max(eig(rho_cov_inv)) * eye(size(K,2));
0084     <span class="keyword">end</span>
0085     rho_cov_inv  = 1/2 * [rho_cov_inv + rho_cov_inv'];
0086     epsilon      = 10^-10;
0087     y_mean       = K(ind_finite,:)' * v_cov_inv * my_v_mean(ind_finite);
0088     ind_signs = find(abs(v_sign_finite)==1);
0089     A         = -diag(v_sign_finite(ind_signs)) * K(ind_signs,:);
0090     b         = -epsilon * ones(length(ind_signs),1);
0091     rho_mean  = quadprog(rho_cov_inv,-y_mean,A,b);
0092     v_projected = zeros(nr,1);
0093     v_projected(ind_nonzeros,1) = K(ind_nonzeros,:) * rho_mean;
0094   
0095   <span class="keyword">case</span> <span class="string">'thermo_correct'</span>,
0096     dd.v.mean = v_mean;
0097     dd.v.std  = v_std;
0098     [options,es_constraints]  = es_default_options(pars.network);
0099     es_constraints.ext_sign   = nan * ones(length(ind_ext),1);
0100     es_constraints.v_sign     = v_sign; 
0101     es_constraints.ind_ignore = pars.ind_ignore; 
0102     v_projected               = <a href="../../../mnt/mnt_fluxes/eba/feasible_fluxes.html" class="code" title="function [v, C] = feasible_fluxes(N,ind_ext,data,es_constraints,eba_condition,C)">feasible_fluxes</a>(N,ind_ext,dd,es_constraints);
0103     
0104 <span class="keyword">end</span>
0105 
0106 <span class="keyword">if</span> pars.remove_eba_cycles,
0107   <span class="keyword">if</span> ~isfield(pars,<span class="string">'C'</span>), pars.C = nan; <span class="keyword">end</span>
0108   [feasible,C,ind_non_orthogonal] = <a href="../../../mnt/mnt_fluxes/flux_feasibility/eba_feasible.html" class="code" title="function [feasible,C,ind_non_orthogonal] = eba_feasible(v,N,C,ind_ignore,eba_condition,cycle_method)">eba_feasible</a>(v_projected,N,pars.C,[],<span class="string">'loose'</span>);
0109   <span class="keyword">if</span> ~feasible,
0110     display(<span class="string">'Removing unfeasible cycles'</span>);
0111     v_projected = <a href="../../../mnt/mnt_fluxes/eba/eba_make_feasible.html" class="code" title="function [v,C] = eba_make_feasible(v,N,eba_condition,C,ind_ignore,cycle_method,ind_ext)">eba_make_feasible</a>(v_projected,N,<span class="string">'loose'</span>,pars.C);
0112   <span class="keyword">end</span>
0113 <span class="keyword">end</span>
0114 
0115 ind_finite = find(isfinite(v_mean));
0116 
0117 <span class="keyword">if</span> norm(v_projected(ind_finite)-v_mean(ind_finite)) / norm(v_mean(ind_finite)) &gt; 0.5,
0118   [v_mean(ind_finite) v_projected(ind_finite)]
0119   figure(1000); plot(v_mean(ind_finite),v_projected(ind_finite),<span class="string">'.'</span>); xlabel(<span class="string">'flux'</span>); ylabel(<span class="string">'projected flux'</span>); title(<span class="string">'Flux change in project\_fluxes.m'</span>)
0120   warning(<span class="string">'Projection leads to considerable change of fluxes'</span>); 
0121 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Fri 05-Apr-2013 16:43:00 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>