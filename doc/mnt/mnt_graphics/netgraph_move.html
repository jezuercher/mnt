<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of netgraph_move</title>
  <meta name="keywords" content="netgraph_move">
  <meta name="description" content="network = netgraph_move(network,flag_draw_details,options,picture,filename_in,filename_out)">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="../index.html">mnt</a> &gt; <a href="index.html">mnt_graphics</a> &gt; netgraph_move.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for mnt/mnt_graphics&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>netgraph_move
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>network = netgraph_move(network,flag_draw_details,options,picture,filename_in,filename_out)</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function network = netgraph_move(network,flag_draw_details,options,picture,filename_in,filename_out) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment">network = netgraph_move(network,flag_draw_details,options,picture,filename_in,filename_out)

move nodes of metabolic network graph with the mouse

 left button:     first click: choose node
                 second click: choose new position
 center button:   relax positions
 right button:    quit

 flag_draw_details (optional): 
  'none': only reaction lines
  'regulation': also regulation lines
  'text': also node names
  'all':  also regulation lines + node names

 options: subfield 'initial_relax' leads to initial relaxation_steps
 options: subfield 'manual' = 0 -&gt; only automatic relaxation</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="netgraph_draw.html" class="code" title="function  network = netgraph_draw(network,varargin)">netgraph_draw</a>	netgraph_draw(network,varargin)</li><li><a href="netgraph_make_graph.html" class="code" title="function network = netgraph_make_graph(network,metvalues,actvalues,set_positions,x_init,table_positions);">netgraph_make_graph</a>	network = netgraph_make_graph(network,metvalues,actvalues,set_positions,x_init,table_positionss);</li><li><a href="netgraph_save_positions.html" class="code" title="function netgraph_save_positions(network,filename,offsets)">netgraph_save_positions</a>	netgraph_save_positions(network,filename,offsets)</li><li><a href="../../mnt/util/label_names.html" class="code" title="function [label,indices] = label_names(names,allnames,method)">label_names</a>	function [label,indices] = label_names(names,allnames, method)</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../demo/demo_small_network.html" class="code" title="">demo_small_network</a>	DEMO_SMALL_NETWORK - Demo for Metabolic Network Toolbox</li><li><a href="netgraph_edit_positions.html" class="code" title="function network = netgraph_edit_positions(network,table_positions,flag_KEGG_ids)">netgraph_edit_positions</a>	network = netgraph_edit_positions(network,table_positions,flag_KEGG_ids)</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function display_graphics(picture,network,p,opt,x,fixed)</a></li><li><a href="#_sub2" class="code">function  x = netgraph_relaxation_step(x,loose,m,k1,k2,k3,k4,gridsize,ind_hub_metabolites)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <span class="comment">%network = netgraph_move(network,flag_draw_details,options,picture,filename_in,filename_out)</span>
0002 <span class="comment">%</span>
0003 <span class="comment">%move nodes of metabolic network graph with the mouse</span>
0004 <span class="comment">%</span>
0005 <span class="comment">% left button:     first click: choose node</span>
0006 <span class="comment">%                 second click: choose new position</span>
0007 <span class="comment">% center button:   relax positions</span>
0008 <span class="comment">% right button:    quit</span>
0009 <span class="comment">%</span>
0010 <span class="comment">% flag_draw_details (optional):</span>
0011 <span class="comment">%  'none': only reaction lines</span>
0012 <span class="comment">%  'regulation': also regulation lines</span>
0013 <span class="comment">%  'text': also node names</span>
0014 <span class="comment">%  'all':  also regulation lines + node names</span>
0015 <span class="comment">%</span>
0016 <span class="comment">% options: subfield 'initial_relax' leads to initial relaxation_steps</span>
0017 <span class="comment">% options: subfield 'manual' = 0 -&gt; only automatic relaxation</span>
0018 
0019 <a name="_sub0" href="#_subfunctions" class="code">function network = netgraph_move(network,flag_draw_details,options,picture,filename_in,filename_out)</a>
0020 
0021 <span class="keyword">if</span> ~exist(<span class="string">'flag_draw_details'</span>,<span class="string">'var'</span>), flag_draw_details = <span class="string">'text'</span>;  <span class="keyword">end</span>;
0022 <span class="keyword">if</span> ~exist(<span class="string">'picture'</span>,<span class="string">'var'</span>), picture = []; <span class="keyword">end</span> 
0023 <span class="keyword">if</span> ~exist(<span class="string">'options'</span>,<span class="string">'var'</span>),  options = struct; <span class="keyword">end</span>
0024 <span class="keyword">if</span> ~isfield(options,<span class="string">'manual'</span>), options.manual = 1; <span class="keyword">end</span>
0025 
0026 <span class="keyword">if</span> isempty(flag_draw_details), flag_draw_details = <span class="string">'none'</span>;  <span class="keyword">end</span>;
0027 
0028 <span class="keyword">if</span> exist(<span class="string">'filename_in'</span>,<span class="string">'var'</span>),
0029   file = fopen(filename_in);
0030   it = 1;
0031   clear x names
0032   <span class="keyword">while</span> ~feof(file),
0033     lin   = fgetl(file);
0034     start = regexp(lin,<span class="string">'[^\s]+'</span>);
0035     stop  = regexp(lin,<span class="string">'[\s]+'</span>);
0036     names{it} = lin(start(1):stop(1)-1);
0037     x(1,it) = eval(lin(start(2):stop(2)-1)); 
0038     x(2,it) = eval(lin(start(3):stop(3)-1));
0039     fixed(it) = eval(lin(start(4):end));
0040     it = it+1;
0041   <span class="keyword">end</span>
0042   fclose(file);
0043   names= names';
0044   ll = <a href="../../mnt/util/label_names.html" class="code" title="function [label,indices] = label_names(names,allnames,method)">label_names</a>(names,network.metabolites);
0045   network.graphics_par.x(:,ll) = x;
0046   network.graphics_par.fixed(ll) = fixed;
0047 <span class="keyword">end</span>
0048 
0049 <span class="keyword">switch</span> flag_draw_details,
0050   <span class="keyword">case</span> <span class="string">'none'</span>, opt = struct(<span class="string">'metstyle'</span>,<span class="string">'none'</span>,<span class="string">'actstyle'</span>,<span class="string">'none'</span>,<span class="string">'metprintnames'</span>,0,<span class="string">'actprintnames'</span>,0,<span class="string">'metprintvalues'</span>,0,<span class="string">'actprintvalues'</span>,0);
0051   <span class="keyword">case</span> <span class="string">'regulation'</span>, opt = struct(<span class="string">'metstyle'</span>,<span class="string">'none'</span>,<span class="string">'actstyle'</span>,<span class="string">'none'</span>,<span class="string">'metprintnames'</span>,0,<span class="string">'actprintnames'</span>,0,<span class="string">'metprintvalues'</span>,0,<span class="string">'actprintvalues'</span>,0,<span class="string">'show_regulation'</span>,1); 
0052   <span class="keyword">case</span> {<span class="string">'text'</span>,<span class="string">'all'</span>}, opt = struct(<span class="string">'metstyle'</span>,<span class="string">'none'</span>,<span class="string">'actstyle'</span>,<span class="string">'none'</span>); 
0053 <span class="keyword">end</span>
0054 
0055 <span class="keyword">if</span> ~isempty(options), 
0056   f = fieldnames(options);
0057   <span class="keyword">for</span> it=1:length(f),
0058     opt = setfield(opt,f{it},getfield(options,f{it}));
0059   <span class="keyword">end</span>
0060 <span class="keyword">end</span>
0061 
0062 <span class="keyword">if</span> ~isfield(network,<span class="string">'graphics_par'</span>),  network=<a href="netgraph_make_graph.html" class="code" title="function network = netgraph_make_graph(network,metvalues,actvalues,set_positions,x_init,table_positions);">netgraph_make_graph</a>(network); <span class="keyword">end</span>
0063 
0064 <span class="comment">% ------------------------------------------------------------</span>
0065 <span class="comment">% layout parameters</span>
0066 
0067 <span class="keyword">if</span> ~isfield(opt,<span class="string">'frame'</span>),
0068   p = network.graphics_par;
0069   <span class="keyword">if</span> sum(sum(p.x ~= 0 )) == 0, opt.frame = [0 1 0 1]; <span class="keyword">end</span> 
0070   opt.frame = [1.1 * min(p.x(1,:))-0.1* max(p.x(1,:)),<span class="keyword">...</span>
0071       -0.1 * min(p.x(1,:))+1.1* max(p.x(1,:)),<span class="keyword">...</span>
0072       1.1 * min(p.x(2,:))-0.1* max(p.x(2,:)),<span class="keyword">...</span>
0073       -0.1 * min(p.x(2,:))+1.1* max(p.x(2,:))];
0074 <span class="comment">% frame of the model</span>
0075 <span class="keyword">end</span>
0076 
0077 a = opt.frame;
0078 
0079 nm        = length(network.graphics_par.metnames);
0080 size_unit = sqrt((a(2)-a(1))*(a(4)-a(3))) * sqrt(1/nm);  <span class="comment">% typical</span>
0081                                                          <span class="comment">% distance</span>
0082                                                          <span class="comment">% between equally spaced dots</span>
0083 force_unit = 0.1;
0084 
0085 gridsize = 0.01  * size_unit;   <span class="comment">% distance between discrete x values</span>
0086 k1       = 0.005 * force_unit;  <span class="comment">% overall repulsion strength</span>
0087 k2       = 0.1   * size_unit;   <span class="comment">% overall repulsion scale</span>
0088 k3       = 0.5   * force_unit;  <span class="comment">% neighbour attraction strength</span>
0089 k4       = 0.5   * size_unit;   <span class="comment">% neighbour attraction scale</span>
0090 
0091 p   = network.graphics_par;
0092 
0093 splitted = 0; <span class="keyword">if</span> isfield(p,<span class="string">'display_split'</span>), splitted = p.display_split;   <span class="keyword">end</span>; 
0094 
0095 <span class="keyword">if</span> splitted,
0096   <span class="keyword">if</span> ~isfield(network.graphics_par,<span class="string">'fixed_split'</span>), 
0097     p.fixed_split = zeros(size(network.graphics_par.x_split,2),1); 
0098   <span class="keyword">end</span>
0099   fixed = p.fixed_split;
0100   N  = p.N_split;
0101   x   = p.x_split;
0102   m   = p.m_split;
0103   n_met = length(p.split_back_mapping);
0104 <span class="keyword">else</span>,
0105   <span class="keyword">if</span> ~isfield(p,<span class="string">'fixed'</span>), p.fixed = zeros(length(network.metabolites)+length(network.actions),1); <span class="keyword">end</span>
0106   fixed = p.fixed;
0107   N  = p.N;
0108   x   = p.x;
0109   m   = p.m;
0110   n_met = length(p.metnames);
0111 <span class="keyword">end</span>
0112 
0113 
0114 <span class="keyword">switch</span> flag_draw_details,
0115   <span class="keyword">case</span> {<span class="string">'regulation'</span>,<span class="string">'all'</span>},
0116     <span class="keyword">if</span> ~isfield(p,<span class="string">'regulation_matrix'</span>); flag_draw_details = <span class="string">'none'</span>; <span class="keyword">end</span>
0117     p.show_regulation = 1; network.graphics_par.show_regulation = 1; 
0118 <span class="keyword">end</span>
0119 
0120 p.arrowstyle=<span class="string">'none'</span>;
0121 
0122 ind_hub_metabolites = find(sum(double(network.N~=0),2)&gt;5);
0123 
0124 <span class="comment">% -----------------------------------------------------------------</span>
0125 <span class="comment">% first relaxation and display</span>
0126 
0127 names=[p.metnames; p.actnames];
0128 loose = find(1-fixed);
0129 
0130 <span class="keyword">if</span> isfield(opt,<span class="string">'initial_relax'</span>),
0131   <span class="keyword">for</span> it = 1:opt.initial_relax, x = <a href="#_sub2" class="code" title="subfunction  x = netgraph_relaxation_step(x,loose,m,k1,k2,k3,k4,gridsize,ind_hub_metabolites)">netgraph_relaxation_step</a>(x,loose,m,k1,k2,k3,k4,gridsize,ind_hub_metabolites); <span class="keyword">end</span>
0132 <span class="keyword">end</span>
0133 
0134 <a href="#_sub1" class="code" title="subfunction display_graphics(picture,network,p,opt,x,fixed)">display_graphics</a>(picture,network,p,opt,x,fixed);
0135 
0136 <span class="comment">% -----------------------------------------------------------------</span>
0137 <span class="comment">% manual relaxation</span>
0138 
0139 <span class="keyword">if</span> opt.manual ~=0, cont = 1; <span class="keyword">else</span>, cont = 0; <span class="keyword">end</span>
0140 
0141 [Ni,Nj]=ind2sub(size(N),find((N~=0)));
0142 Nj = Nj+n_met;
0143 
0144 <span class="comment">%edgecenters = 0.5*(x(:,Ni)+x(:,Nj));</span>
0145 <span class="comment">%hold on;      %     plot(edgecenters(1,:),edgecenters(2,:),'g.');</span>
0146 <span class="comment">%fixed_ind = find(fixed);</span>
0147 <span class="comment">%plot(x(1,fixed_ind),x(2,fixed_ind),'k.');</span>
0148 <span class="comment">%hold off;</span>
0149 <span class="comment">%loose = find(1-fixed);</span>
0150 
0151 <span class="comment">% m is the adjacency matrix</span>
0152 
0153 <span class="keyword">while</span> cont==1,
0154 
0155   [x_old,y_old,button] = ginput(1);
0156 
0157   <span class="keyword">switch</span> button
0158     
0159     <span class="keyword">case</span> 1,
0160       dist    = sum( (repmat([x_old;y_old],1,size(x,2))-x).^2);
0161       [dum,i] = min(dist);
0162       index   = i(1);
0163       title(<span class="string">'Left &gt; place node. Center &gt; place and fix node'</span>);
0164       [x_new,y_new,button] = ginput(1);
0165             x(:,index) = [x_new;y_new];
0166 <span class="comment">%      factors = exp(-db(index,:)/p.lambda);</span>
0167 <span class="comment">%      x(:,loose) = x(:,loose) + [x_new-x_old; y_new-y_old] * factors(:,loose);</span>
0168       <span class="keyword">if</span>  button-1 ~= fixed(index),
0169     fixed(index) = button-1;
0170     loose = find(1-fixed);
0171       <span class="keyword">end</span>
0172       
0173     <span class="keyword">case</span> 2,  <span class="keyword">for</span> it = 1:20, x = <a href="#_sub2" class="code" title="subfunction  x = netgraph_relaxation_step(x,loose,m,k1,k2,k3,k4,gridsize,ind_hub_metabolites)">netgraph_relaxation_step</a>(x,loose,m,k1,k2,k3,k4,gridsize,ind_hub_metabolites); <span class="keyword">end</span>
0174 
0175     <span class="keyword">case</span> 3,   cont = 0; 
0176   <span class="keyword">end</span>
0177 
0178 <span class="comment">%  edgecenters = 0.5*(x(:,Ni)+x(:,Nj));</span>
0179   
0180   <span class="keyword">if</span> splitted,     p.x_split = x;
0181   <span class="keyword">else</span>,            p.x = x;
0182   <span class="keyword">end</span>
0183   
0184   network.graphics_par=p;
0185 
0186   <a href="#_sub1" class="code" title="subfunction display_graphics(picture,network,p,opt,x,fixed)">display_graphics</a>(picture,network,p,opt,x,fixed);  
0187   
0188 <span class="keyword">end</span>
0189 
0190 <span class="keyword">if</span> exist(<span class="string">'filename_out'</span>,<span class="string">'var'</span>), <a href="netgraph_save_positions.html" class="code" title="function netgraph_save_positions(network,filename,offsets)">netgraph_save_positions</a>(network,filename_out); <span class="keyword">end</span>
0191 <span class="keyword">if</span> opt.manual, title(<span class="string">'New positions confirmed'</span>); <span class="keyword">end</span>
0192 
0193 p.x      = x; 
0194 p.fixed = fixed; 
0195 
0196 <span class="keyword">if</span> splitted,
0197   p.x_split     = x; 
0198   p.fixed_split = fixed; 
0199 <span class="keyword">end</span>
0200 
0201 network.graphics_par = p;
0202 
0203 <span class="comment">% --------------------------------------------------------------------------------</span>
0204 
0205 <a name="_sub1" href="#_subfunctions" class="code">function display_graphics(picture,network,p,opt,x,fixed)</a>
0206 
0207 <span class="keyword">if</span> opt.manual,
0208 
0209 network.graphics_par = p;
0210 network.graphics_par.x = x;
0211 
0212 <span class="keyword">if</span> exist(<span class="string">'picture'</span>,<span class="string">'var'</span>), 
0213   image(picture); 
0214   hold on;
0215 <span class="keyword">end</span>;
0216 
0217 <a href="netgraph_draw.html" class="code" title="function  network = netgraph_draw(network,varargin)">netgraph_draw</a>(network,opt); hold on;
0218 title(<span class="string">'Left &gt; move node. Center &gt; relax network. Right &gt; finish'</span>);
0219 
0220 fixed_ind = find(fixed);
0221 plot(x(1,fixed_ind),x(2,fixed_ind),<span class="string">'k.'</span>); 
0222 hold off;
0223 <span class="keyword">if</span> isfield(opt,<span class="string">'Axis'</span>), 
0224   axis(opt.Axis); 
0225 <span class="keyword">else</span>,
0226   axis(opt.frame);
0227 <span class="keyword">end</span>
0228 axis tight
0229 <span class="keyword">end</span>
0230 
0231 <span class="comment">% --------------------------------------------------------------------------------</span>
0232 
0233 <a name="_sub2" href="#_subfunctions" class="code">function  x = netgraph_relaxation_step(x,loose,m,k1,k2,k3,k4,gridsize,ind_hub_metabolites)</a>
0234 
0235 x(:,loose) = x(:,loose) + 0.001*randn(2,length(loose));
0236 
0237 <span class="comment">% spring forces:</span>
0238 f2 = (( m(loose,:)*x')- repmat(sum(m(loose,:),2),1,2).*x(:,loose)')';
0239 
0240 <span class="comment">% nonlinear springs</span>
0241 
0242 f2_norm = sqrt(sum(f2.^2))/k4;
0243 f2      = f2 .*repmat( 0.5*f2_norm+1./(0.2+f2_norm),2,1);
0244 
0245 <span class="comment">% repelling forces</span>
0246 thresh = 10*k2;
0247 d1 = abs( repmat(x(1,:),length(loose),1)-repmat(x(1,loose)',1,size(x,2))) &lt; thresh;
0248 d2 = abs( repmat(x(2,:),length(loose),1)-repmat(x(2,loose)',1,size(x,2))) &lt; thresh;
0249 <span class="comment">%d_non_neighb =</span>
0250 d3 = d1.*d2.*(1-m(loose,:));
0251 d3(:,1:size(d3,1)) = d3(:,1:size(d3,1)) - speye( size(d3,1));
0252 has_neighbours = find(sum(d3,2));
0253 
0254 f0 = zeros(2,size(d3,1));      
0255 <span class="comment">%      for it=1:1,</span>
0256 <span class="comment">%    edgecenters = 0.5*(x(:,Ni)+x(:,Nj));</span>
0257 
0258 <span class="keyword">for</span> ittt=1:length(has_neighbours);
0259   itt = has_neighbours(ittt);
0260   neighbours = find(d3(itt,:));
0261   distances = repmat(x(:,loose(itt)),1,length(neighbours)) - x(:,neighbours);
0262   f1 = sum(distances.^2)+10^-10;
0263   f1 = exp(-f1/(2*k2^2))./sqrt(f1);
0264   f0(:,itt) = sum(distances.*repmat(f1,2,1),2);      
0265 <span class="keyword">end</span>
0266 <span class="comment">%      end</span>
0267 
0268 <span class="comment">%f2(:,ind_hub_metabolites) = 0;</span>
0269 
0270 <span class="keyword">if</span> length(loose),
0271   force_loose = 0*k3 * f2 + k1 * f0;
0272   x(:,loose) = x(:,loose) + force_loose;
0273   x(:,loose) = x(:,loose)-repmat(min(x(:,loose)')',1,size(x(:,loose),2));
0274 <span class="comment">%  x(:,loose) = diag(1./(max(x(:,loose)')'))*x(:,loose);</span>
0275 <span class="comment">%  x(:,loose) = gridsize * round(x(:,loose)/gridsize);</span>
0276 <span class="keyword">end</span>
0277 
0278  x(1,:) = x(1,:)-min(x(1,:)); x(1,:) = x(1,:)/max(x(1,:));
0279  x(2,:) = x(2,:)-min(x(2,:)); x(2,:) = x(2,:)/max(x(2,:));</pre></div>
<hr><address>Generated on Fri 05-Apr-2013 16:43:00 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>