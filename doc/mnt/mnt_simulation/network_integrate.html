<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of network_integrate</title>
  <meta name="keywords" content="network_integrate">
  <meta name="description" content="[t, s, s_int, met_int,v,x_assign] = network_integrate(network, s_init, T, graphics_flag, verbose_flag,Tmax,dilution_rate,ode_opt)">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="../index.html">mnt</a> &gt; <a href="index.html">mnt_simulation</a> &gt; network_integrate.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for mnt/mnt_simulation&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>network_integrate
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>[t, s, s_int, met_int,v,x_assign] = network_integrate(network, s_init, T, graphics_flag, verbose_flag,Tmax,dilution_rate,ode_opt)</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function [t, s_t, s_int_t, met_int,v,x_assign] = network_integrate(network, s_init, T, graphics_flag, verbose_flag, Tmax,dilution_rate,ode_opt) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment">[t, s, s_int, met_int,v,x_assign] = network_integrate(network, s_init, T, graphics_flag, verbose_flag,Tmax,dilution_rate,ode_opt)

solve differential equations for metabolic network with field 'kinetics'

network    network data structure (see 'metabolic_networks')
s          initial concentrations (row vector)
T          integration time (duration or vector of timepoints)

t          vector of time points
s_int, s   (matrices) timecourses of internal/all metabolite concentrations
met_int    list of internal metabolites
v          reaction velocities
x_assign   values of variables giuven by assignment rules

 for visualising the results at one time point, type
 i=1;  % (number of time point)
 netgraph_draw(network,'metvalues',s_t(:,i),'actvalues',...
               network_velocities(s_t(:,i),network,network.kinetics));</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../mnt/mnt_kinetics/kinetics/network_velocities.html" class="code" title="function v = network_velocities(s, network, kinetics, split, indices,t)">network_velocities</a>	v = network_velocities(s,network,kinetics,split,indices,t)</li><li><a href="network_integrate_kin.html" class="code" title="function [t,x,v,t_pre,x_pre,p,p_pre] = network_integrate_kin(x0,pp,T1,T2,N,velocity_function,delta_par,external)">network_integrate_kin</a>	[t,x,v,t_pre,x_pre,p_p_pre] = network_integrate_kin(x0,pp,T1,T2,N,velocity_function,delta_par,external)</li><li><a href="../../mnt/utils/label_names.html" class="code" title="function [label,indices] = label_names(names,allnames,method)">label_names</a>	function [label,indices] = label_names(names,allnames, method)</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../demo/mnt_demo.html" class="code" title="">mnt_demo</a>	</li><li><a href="network_steady_state.html" class="code" title="function  [S, J, Sdot, error,L_int,NR_int,indep_met_int] = network_steady_state(network,s,integrate_time,L_int,NR_int,indep_met_int,dilution_rate)">network_steady_state</a>	[S, J, Sdot, error] = network_steady_state(network,s,integrate_time,L_int,NR_int,indep_met_int,dilution_rate)</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function f = integrate_network_der(t,s_int,network,internal,external,s_ext,N_int,verbose_flag,dilution_rate)</a></li><li><a href="#_sub2" class="code">function f = integrate_network_der_dil(t,s_int,network,internal,external,s_ext,N_int,verbose_flag,dilution_rate)</a></li><li><a href="#_sub3" class="code">function f = integrate_network_der_MA(t,s_int,s_ext,Nf_int,Nb_int,Nk_fwdT,Nk_bwdT)</a></li><li><a href="#_sub4" class="code">function f = timer_error()</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <span class="comment">%[t, s, s_int, met_int,v,x_assign] = network_integrate(network, s_init, T, graphics_flag, verbose_flag,Tmax,dilution_rate,ode_opt)</span>
0002 <span class="comment">%</span>
0003 <span class="comment">%solve differential equations for metabolic network with field 'kinetics'</span>
0004 <span class="comment">%</span>
0005 <span class="comment">%network    network data structure (see 'metabolic_networks')</span>
0006 <span class="comment">%s          initial concentrations (row vector)</span>
0007 <span class="comment">%T          integration time (duration or vector of timepoints)</span>
0008 <span class="comment">%</span>
0009 <span class="comment">%t          vector of time points</span>
0010 <span class="comment">%s_int, s   (matrices) timecourses of internal/all metabolite concentrations</span>
0011 <span class="comment">%met_int    list of internal metabolites</span>
0012 <span class="comment">%v          reaction velocities</span>
0013 <span class="comment">%x_assign   values of variables giuven by assignment rules</span>
0014 <span class="comment">%</span>
0015 <span class="comment">% for visualising the results at one time point, type</span>
0016 <span class="comment">% i=1;  % (number of time point)</span>
0017 <span class="comment">% netgraph_draw(network,'metvalues',s_t(:,i),'actvalues',...</span>
0018 <span class="comment">%               network_velocities(s_t(:,i),network,network.kinetics));</span>
0019 
0020 <a name="_sub0" href="#_subfunctions" class="code">function [t, s_t, s_int_t, met_int,v,x_assign] = network_integrate(network, s_init, T, graphics_flag, verbose_flag, Tmax,dilution_rate,ode_opt)</a>
0021 
0022 <span class="keyword">if</span> ~exist(<span class="string">'s_init'</span>,<span class="string">'var'</span>), s_init = rand(size(network.metabolites)); <span class="keyword">end</span>
0023 <span class="keyword">if</span> ~exist(<span class="string">'T'</span>,<span class="string">'var'</span>),      T = 1; <span class="keyword">end</span>
0024 <span class="keyword">if</span> ~exist(<span class="string">'graphics_flag'</span>,<span class="string">'var'</span>), graphics_flag = 0; <span class="keyword">end</span>
0025 <span class="keyword">if</span> ~exist(<span class="string">'verbose_flag'</span>,<span class="string">'var'</span>),  verbose_flag = 0; <span class="keyword">end</span>
0026 <span class="keyword">if</span> ~exist(<span class="string">'Tmax'</span>,<span class="string">'var'</span>),          Tmax = []; <span class="keyword">end</span>
0027 <span class="keyword">if</span> ~exist(<span class="string">'dilution_rate'</span>,<span class="string">'var'</span>), dilution_rate = []; <span class="keyword">end</span>
0028 <span class="keyword">if</span> ~exist(<span class="string">'ode_opt'</span>,<span class="string">'var'</span>), ode_opt = []; <span class="keyword">end</span>
0029 <span class="keyword">if</span> ~isfield(network.kinetics,<span class="string">'assignment_function'</span>), network.kinetics.assignment_function = []; <span class="keyword">end</span>
0030 
0031 <span class="keyword">if</span> length(Tmax),
0032   my_timer = timer(<span class="string">'TimerFcn'</span>,@<a href="#_sub4" class="code" title="subfunction f = timer_error()">timer_error</a>, <span class="string">'Period'</span>, Tmax);
0033 <span class="keyword">end</span>
0034 
0035 <span class="keyword">if</span> ~isempty(network.kinetics.assignment_function),
0036   [dd,ddd] = feval(network.kinetics.assignment_function,s_init,network.kinetics.parameters);
0037   ind_assignment = <a href="../../mnt/utils/label_names.html" class="code" title="function [label,indices] = label_names(names,allnames,method)">label_names</a>(ddd, network.metabolites);
0038   ind_assignment = ind_assignment(find(ind_assignment));
0039   network.external(ind_assignment) = 1;
0040 <span class="keyword">else</span>
0041   ind_assignment = [];
0042 <span class="keyword">end</span>
0043 
0044 [n_S,n_A] = size(network.N);
0045 external  = find(network.external);
0046 internal  = setdiff(1:n_S,external)';
0047 s_int     = s_init(internal);
0048 s_ext     = s_init(external);
0049 
0050 N     = network.N;
0051 N_int = N(internal,:);
0052 
0053 <span class="keyword">if</span> length(T)==1, T = [0,T]; <span class="keyword">end</span>
0054 
0055 <span class="keyword">switch</span> network.kinetics.type,
0056   
0057   <span class="keyword">case</span> <span class="string">'numeric'</span>,
0058     N_internal = N;
0059     [t, s_t] = <a href="network_integrate_kin.html" class="code" title="function [t,x,v,t_pre,x_pre,p,p_pre] = network_integrate_kin(x0,pp,T1,T2,N,velocity_function,delta_par,external)">network_integrate_kin</a>(s_init,network.kinetics.parameters,0,T,N_internal,network.kinetics.velocity_function,[],network.external);
0060     <span class="comment">%if length(T)&gt;2,</span>
0061       <span class="comment">%s_t = interp1(t,s_t,T);</span>
0062       <span class="comment">%t = T;</span>
0063     <span class="comment">%end</span>
0064     s_int_t = s_t(:,internal);
0065 
0066   <span class="keyword">case</span> <span class="string">'mass-action'</span>,
0067     [n_met,n_A] = size(N);
0068     
0069     <span class="keyword">if</span> isfield(network.kinetics,<span class="string">'exponents'</span>),
0070       Nf = network.kinetics.exponents.*(N&lt;0);
0071       Nb = network.kinetics.exponents.*(N&gt;0);
0072     <span class="keyword">else</span>,
0073       Nf  = abs(N.*(N&lt;0));
0074       Nb  =     N.*(N&gt;0);      
0075      <span class="keyword">end</span>
0076 
0077      Nfint = Nf(internal,:);
0078      Nbint = Nb(internal,:);
0079      
0080      <span class="keyword">if</span> isempty(external), 
0081        Nk_fwdT = Nf(external,:); 
0082        Nk_bwdT = Nf(external,:);
0083      <span class="keyword">else</span>,
0084        df = prod( repmat(s_init(external),1,n_A) .^ Nf(external,:));
0085        db = prod( repmat(s_init(external),1,n_A) .^ Nb(external,:));
0086        k_fwdT = network.kinetics.k_fwd .* df';
0087        k_bwdT = network.kinetics.k_bwd .* db';
0088        Nk_fwdT = N_int * sparse(diag(k_fwdT));
0089        Nk_bwdT = N_int * sparse(diag(k_bwdT));
0090      <span class="keyword">end</span>
0091      optoptions = odeset(<span class="string">'NonNegative'</span>,1:length(s_int),<span class="string">'RelTol'</span>, 1e-6);
0092      [t,s_int_t] = ode15s(@<a href="#_sub3" class="code" title="subfunction f = integrate_network_der_MA(t,s_int,s_ext,Nf_int,Nb_int,Nk_fwdT,Nk_bwdT)">integrate_network_der_MA</a>,T,s_int,optoptions,s_ext,Nfint,Nbint,Nk_fwdT,Nk_bwdT);
0093      
0094    <span class="keyword">otherwise</span>,
0095      
0096      odeoptions = odeset(<span class="string">'NonNegative'</span>,1:length(s_int),<span class="string">'RelTol'</span>, 1e-6);
0097      
0098      <span class="keyword">if</span> length(dilution_rate),
0099        [t,s_int_t] = ode15s(@<a href="#_sub2" class="code" title="subfunction f = integrate_network_der_dil(t,s_int,network,internal,external,s_ext,N_int,verbose_flag,dilution_rate)">integrate_network_der_dil</a>,T,s_int,odeoptions,network,<span class="keyword">...</span>
0100                             internal,external,s_ext,N_int,verbose_flag,dilution_rate);
0101      <span class="keyword">else</span>,
0102        [t,s_int_t] = ode15s(@<a href="#_sub1" class="code" title="subfunction f = integrate_network_der(t,s_int,network,internal,external,s_ext,N_int,verbose_flag,dilution_rate)">integrate_network_der</a>,T,s_int,odeoptions,network,<span class="keyword">...</span>
0103                             internal,external,s_ext,N_int,verbose_flag,dilution_rate);
0104      <span class="keyword">end</span>
0105 <span class="keyword">end</span>
0106  
0107 s_int_t         = s_int_t';
0108 s_t             = ones(n_S,length(t)); 
0109 s_t(internal,:) = s_int_t; 
0110 
0111 <span class="keyword">if</span> length(external), s_t(external,:) = repmat(s_ext,1,length(t)); <span class="keyword">end</span>
0112 
0113 <span class="keyword">if</span> ~isempty(ind_assignment),
0114   <span class="keyword">for</span> it = 1:length(t),
0115     this_s = s_t(:,it);
0116     [this_assignment,ddd] = feval(network.kinetics.assignment_function,this_s,network.kinetics.parameters);
0117     ii = <a href="../../mnt/utils/label_names.html" class="code" title="function [label,indices] = label_names(names,allnames,method)">label_names</a>(ddd,network.metabolites); ii = ii(find(ii));
0118     s_t(ind_assignment,it) = this_assignment(ii);
0119    <span class="keyword">end</span>
0120 <span class="keyword">end</span>
0121  
0122 met_int = network.metabolites(internal);
0123 
0124 <span class="comment">%% --------------------------------------------------------------------</span>
0125 <span class="comment">%% compute fluxes</span>
0126 
0127 <span class="keyword">if</span> nargout &gt;4,
0128   
0129   <span class="keyword">switch</span> network.kinetics.type,
0130     
0131     <span class="keyword">case</span> <span class="string">'numeric'</span>,
0132       <span class="keyword">for</span> it=1:length(t),
0133         v(:,it) = feval(network.kinetics.velocity_function,s_t(:,it),network.kinetics.parameters,t(it));
0134       <span class="keyword">end</span>
0135     
0136     <span class="keyword">otherwise</span>,
0137       <span class="keyword">for</span> it=1:length(t),
0138         v(:,it) = <a href="../../mnt/mnt_kinetics/kinetics/network_velocities.html" class="code" title="function v = network_velocities(s, network, kinetics, split, indices,t)">network_velocities</a>(s_t(:,it),network);
0139       <span class="keyword">end</span>
0140   <span class="keyword">end</span>
0141 
0142   <span class="keyword">if</span> ~isempty(network.kinetics.assignment_function),
0143     <span class="keyword">for</span> it=1:length(t),
0144       x_assign(:,it) = feval(network.kinetics.assignment_function,network.kinetics.parameters,s_t(:,it));
0145     <span class="keyword">end</span>
0146   <span class="keyword">end</span>
0147 
0148 <span class="keyword">end</span>
0149  
0150 <span class="keyword">if</span> length(Tmax),
0151   stop(my_timer);
0152 <span class="keyword">end</span>
0153  
0154 
0155 <span class="comment">% --------------------------------------------------------------------</span>
0156 
0157 <a name="_sub1" href="#_subfunctions" class="code">function f = integrate_network_der(t,s_int,network,internal,external,s_ext,N_int,verbose_flag,dilution_rate)</a>
0158 
0159 <span class="keyword">if</span> verbose_flag,
0160   t
0161 <span class="keyword">end</span>
0162 
0163 <span class="comment">% vector f contains time derivative of the internal metabolites</span>
0164 
0165 s(internal)  = s_int;
0166 s(external)  = s_ext;
0167 f            = N_int * <a href="../../mnt/mnt_kinetics/kinetics/network_velocities.html" class="code" title="function v = network_velocities(s, network, kinetics, split, indices,t)">network_velocities</a>(s,network);
0168 
0169 <span class="comment">% --------------------------------------------------------------------</span>
0170 
0171 <a name="_sub2" href="#_subfunctions" class="code">function f = integrate_network_der_dil(t,s_int,network,internal,external,s_ext,N_int,verbose_flag,dilution_rate)</a>
0172 
0173 <span class="comment">% vector f contains time derivative of the internal metabolites</span>
0174 
0175 s(internal)  = s_int;
0176 s(external)  = s_ext;
0177 f            = N_int * <a href="../../mnt/mnt_kinetics/kinetics/network_velocities.html" class="code" title="function v = network_velocities(s, network, kinetics, split, indices,t)">network_velocities</a>(s,network) - dilution_rate * s_int;
0178 
0179 <span class="comment">% --------------------------------------------------------------------</span>
0180 
0181 <a name="_sub3" href="#_subfunctions" class="code">function f = integrate_network_der_MA(t,s_int,s_ext,Nf_int,Nb_int,Nk_fwdT,Nk_bwdT)</a>
0182 
0183 <span class="comment">% vector f contains time derivative of the internal metabolites</span>
0184 
0185 log_s_int = log(s_int+10^-14);
0186 f         = Nk_fwdT *  exp(Nf_int' * log_s_int )   -   Nk_bwdT *  exp(Nb_int' * log_s_int);
0187 
0188 <span class="comment">% --------------------------------------------------------------------</span>
0189 
0190 <a name="_sub4" href="#_subfunctions" class="code">function f = timer_error()</a>
0191 
0192 display(<span class="string">'Calculation time exceeded'</span>);
0193 error</pre></div>
<hr><address>Generated on Wed 10-Apr-2013 10:42:33 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>