<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of network_integrate</title>
  <meta name="keywords" content="network_integrate">
  <meta name="description" content="[t, s, s_int, met_int,v,x_assign] = network_integrate(network, s_init, T, graphics_flag, verbose_flag,Tmax,dilution_rate,ode_opt)">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="#">mnt</a> &gt; <a href="#">mnt_simulation</a> &gt; network_integrate.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for ./mnt/mnt_simulation&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>network_integrate
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>[t, s, s_int, met_int,v,x_assign] = network_integrate(network, s_init, T, graphics_flag, verbose_flag,Tmax,dilution_rate,ode_opt)</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function [t, s_t, s_int_t, met_int,v,x_assign] = network_integrate(network, s_init, T, graphics_flag, verbose_flag, Tmax,dilution_rate,ode_opt) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment">[t, s, s_int, met_int,v,x_assign] = network_integrate(network, s_init, T, graphics_flag, verbose_flag,Tmax,dilution_rate,ode_opt)

solve differential equations for metabolic network with field 'kinetics'

network    network data structure (see 'metabolic_networks')
s          initial concentrations (row vector)
T          integration time (duration or vector of timepoints)

t          vector of time points
s_int, s   (matrices) timecourses of internal/all metabolite concentrations
met_int    list of internal metabolites
v          reaction velocities
x_assign   values of variables giuven by assignment rules

 Information about compartment volumes can be given in fields
 'metabolite_compartments', 'compartments', and 'compartment_sizes'
 If 'metabolite_compartments' does not exist, all metabolites are considered in a volume of 1

 for visualising the results at one time point, type
 i=1;  % (number of time point)
 netgraph_draw(network,'metvalues',s_t(:,i),'actvalues',...
               network_velocities(s_t(:,i),network,network.kinetics));</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../.././mnt/mnt_kinetics/kinetics/network_velocities.html" class="code" title="function v = network_velocities(s, network, kinetics, split, indices,t)">network_velocities</a>	v = network_velocities(s,network,kinetics,split,indices,t)</li><li><a href="network_integrate_kin.html" class="code" title="function [t,x,v,t_pre,x_pre,p,p_pre] = network_integrate_kin(x0,pp,T1,T2,N,velocity_function,delta_par,external,volumes,verbose_flag)">network_integrate_kin</a>	[t,x,v,t_pre,x_pre,p_p_pre] = network_integrate_kin(x0,pp,T1,T2,N,velocity_function,delta_par,external,volumes,verbose_flag)</li><li><a href="../.././mnt/utils/label_names.html" class="code" title="function [label,indices] = label_names(names,allnames,method)">label_names</a>	function [label,indices] = label_names(names,allnames, method)</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../.././demo/mnt_demo.html" class="code" title="">mnt_demo</a>	</li><li><a href="network_steady_state.html" class="code" title="function  [S, J, Sdot, error,L_int,NR_int,indep_met_int] = network_steady_state(network,s,integrate_time,L_int,NR_int,indep_met_int,dilution_rate)">network_steady_state</a>	[S, J, Sdot, error] = network_steady_state(network,s,integrate_time,L_int,NR_int,indep_met_int,dilution_rate)</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function f = integrate_network_der(t,s_int,network,internal,external,s_ext,N_int,verbose_flag)</a></li><li><a href="#_sub2" class="code">function f = integrate_network_der_dil(t,s_int,network,internal,external,s_ext,N_int,verbose_flag,dilution_rate)</a></li><li><a href="#_sub3" class="code">function f = integrate_network_der_MA(t,s_int,s_ext,Nf_int,Nb_int,Nk_fwdT,Nk_bwdT)</a></li><li><a href="#_sub4" class="code">function f = timer_error()</a></li></ul>
<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <span class="comment">%[t, s, s_int, met_int,v,x_assign] = network_integrate(network, s_init, T, graphics_flag, verbose_flag,Tmax,dilution_rate,ode_opt)</span>
0002 <span class="comment">%</span>
0003 <span class="comment">%solve differential equations for metabolic network with field 'kinetics'</span>
0004 <span class="comment">%</span>
0005 <span class="comment">%network    network data structure (see 'metabolic_networks')</span>
0006 <span class="comment">%s          initial concentrations (row vector)</span>
0007 <span class="comment">%T          integration time (duration or vector of timepoints)</span>
0008 <span class="comment">%</span>
0009 <span class="comment">%t          vector of time points</span>
0010 <span class="comment">%s_int, s   (matrices) timecourses of internal/all metabolite concentrations</span>
0011 <span class="comment">%met_int    list of internal metabolites</span>
0012 <span class="comment">%v          reaction velocities</span>
0013 <span class="comment">%x_assign   values of variables giuven by assignment rules</span>
0014 <span class="comment">%</span>
0015 <span class="comment">% Information about compartment volumes can be given in fields</span>
0016 <span class="comment">% 'metabolite_compartments', 'compartments', and 'compartment_sizes'</span>
0017 <span class="comment">% If 'metabolite_compartments' does not exist, all metabolites are considered in a volume of 1</span>
0018 <span class="comment">%</span>
0019 <span class="comment">% for visualising the results at one time point, type</span>
0020 <span class="comment">% i=1;  % (number of time point)</span>
0021 <span class="comment">% netgraph_draw(network,'metvalues',s_t(:,i),'actvalues',...</span>
0022 <span class="comment">%               network_velocities(s_t(:,i),network,network.kinetics));</span>
0023 
0024 <a name="_sub0" href="#_subfunctions" class="code">function [t, s_t, s_int_t, met_int,v,x_assign] = network_integrate(network, s_init, T, graphics_flag, verbose_flag, Tmax,dilution_rate,ode_opt)</a>
0025 
0026 <span class="keyword">if</span> ~exist(<span class="string">'s_init'</span>,<span class="string">'var'</span>),        s_init = rand(size(network.metabolites)); <span class="keyword">end</span>
0027 <span class="keyword">if</span> ~exist(<span class="string">'T'</span>,<span class="string">'var'</span>),             T      = 1; <span class="keyword">end</span>
0028 <span class="keyword">if</span> ~exist(<span class="string">'graphics_flag'</span>,<span class="string">'var'</span>), graphics_flag = 0; <span class="keyword">end</span>
0029 <span class="keyword">if</span> ~exist(<span class="string">'verbose_flag'</span>,<span class="string">'var'</span>),  verbose_flag = 0; <span class="keyword">end</span>
0030 <span class="keyword">if</span> ~exist(<span class="string">'Tmax'</span>,<span class="string">'var'</span>),          Tmax    = []; <span class="keyword">end</span>
0031 <span class="keyword">if</span> ~exist(<span class="string">'dilution_rate'</span>,<span class="string">'var'</span>), dilution_rate = []; <span class="keyword">end</span>
0032 <span class="keyword">if</span> ~exist(<span class="string">'ode_opt'</span>,<span class="string">'var'</span>),       ode_opt = []; <span class="keyword">end</span>
0033 <span class="keyword">if</span> ~isfield(network.kinetics,<span class="string">'assignment_function'</span>), 
0034   network.kinetics.assignment_function = []; 
0035 <span class="keyword">end</span>
0036 
0037 <span class="keyword">if</span> length(Tmax),
0038   my_timer = timer(<span class="string">'TimerFcn'</span>,@<a href="#_sub4" class="code" title="subfunction f = timer_error()">timer_error</a>, <span class="string">'Period'</span>, Tmax);
0039 <span class="keyword">end</span>
0040 
0041 <span class="keyword">if</span> ~isempty(network.kinetics.assignment_function),
0042   [dd,ddd] = feval(network.kinetics.assignment_function,s_init,network.kinetics.parameters);
0043   ind_assignment = <a href="../.././mnt/utils/label_names.html" class="code" title="function [label,indices] = label_names(names,allnames,method)">label_names</a>(ddd, network.metabolites);
0044   ind_assignment = ind_assignment(find(ind_assignment));
0045   network.external(ind_assignment) = 1;
0046 <span class="keyword">else</span>
0047   ind_assignment = [];
0048 <span class="keyword">end</span>
0049 
0050 [n_S,n_A] = size(network.N);
0051 external  = find(network.external);
0052 internal  = setdiff(1:n_S,external)';
0053 s_int     = s_init(internal);
0054 s_ext     = s_init(external);
0055 
0056 volumes = ones(length(internal),1);
0057 <span class="keyword">if</span> isfield(network,<span class="string">'metabolite_compartments'</span>),
0058   ll = <a href="../.././mnt/utils/label_names.html" class="code" title="function [label,indices] = label_names(names,allnames,method)">label_names</a>(network.metabolite_compartments(internal), network.compartments);
0059   volumes = network.compartment_sizes(ll);
0060   <span class="keyword">if</span> verbose_flag, 
0061     display(<span class="string">'Dynamic simulation: Using given compartment volumes = 1'</span>); <span class="keyword">end</span>
0062 <span class="keyword">else</span>,
0063   <span class="keyword">if</span> verbose_flag, 
0064     display(<span class="string">'Dynamic simulation: Assuming compartment volumes = 1'</span>); <span class="keyword">end</span>
0065 <span class="keyword">end</span>
0066 
0067 N     = network.N;
0068 N_int = diag(1./volumes) * N(internal,:);
0069 
0070 <span class="keyword">if</span> length(T)==1, T = [0,T]; <span class="keyword">end</span>
0071 
0072 <span class="keyword">switch</span> network.kinetics.type,
0073   
0074   <span class="keyword">case</span> <span class="string">'numeric'</span>,
0075     [t, s_t] = <a href="network_integrate_kin.html" class="code" title="function [t,x,v,t_pre,x_pre,p,p_pre] = network_integrate_kin(x0,pp,T1,T2,N,velocity_function,delta_par,external,volumes,verbose_flag)">network_integrate_kin</a>(s_init,network.kinetics.parameters,0,T,N,network.kinetics.velocity_function,[],network.external,[],verbose_flag);
0076     s_int_t = s_t(:,internal);
0077 
0078   <span class="keyword">case</span> <span class="string">'mass-action'</span>,
0079     [n_met,n_A] = size(N);
0080     
0081     <span class="keyword">if</span> isfield(network.kinetics,<span class="string">'exponents'</span>),
0082       Nf = network.kinetics.exponents.*(N&lt;0);
0083       Nb = network.kinetics.exponents.*(N&gt;0);
0084     <span class="keyword">else</span>,
0085       Nf  = abs(N.*(N&lt;0));
0086       Nb  =     N.*(N&gt;0);      
0087      <span class="keyword">end</span>
0088 
0089      Nfint = Nf(internal,:);
0090      Nbint = Nb(internal,:);
0091      
0092      <span class="keyword">if</span> isempty(external), 
0093        Nk_fwdT = Nf(external,:); 
0094        Nk_bwdT = Nf(external,:);
0095      <span class="keyword">else</span>,
0096        df = prod( repmat(s_init(external),1,n_A) .^ Nf(external,:));
0097        db = prod( repmat(s_init(external),1,n_A) .^ Nb(external,:));
0098        k_fwdT = network.kinetics.k_fwd .* df';
0099        k_bwdT = network.kinetics.k_bwd .* db';
0100        Nk_fwdT = N_int * sparse(diag(k_fwdT));
0101        Nk_bwdT = N_int * sparse(diag(k_bwdT));
0102      <span class="keyword">end</span>
0103      optoptions = odeset(<span class="string">'NonNegative'</span>,1:length(s_int),<span class="string">'RelTol'</span>, 1e-6);
0104      [t,s_int_t] = ode15s(@<a href="#_sub3" class="code" title="subfunction f = integrate_network_der_MA(t,s_int,s_ext,Nf_int,Nb_int,Nk_fwdT,Nk_bwdT)">integrate_network_der_MA</a>,T,s_int,optoptions,s_ext,Nfint,Nbint,Nk_fwdT,Nk_bwdT);
0105      
0106    <span class="keyword">otherwise</span>,
0107      
0108      odeoptions = odeset(<span class="string">'NonNegative'</span>,1:length(s_int),<span class="string">'RelTol'</span>, 1e-6);
0109      
0110      <span class="keyword">if</span> length(dilution_rate),
0111        [t,s_int_t] = ode15s(@<a href="#_sub2" class="code" title="subfunction f = integrate_network_der_dil(t,s_int,network,internal,external,s_ext,N_int,verbose_flag,dilution_rate)">integrate_network_der_dil</a>,T,s_int,odeoptions,network,<span class="keyword">...</span>
0112                             internal,external,s_ext,N_int,verbose_flag,dilution_rate);
0113      <span class="keyword">else</span>,
0114        [t,s_int_t] = ode15s(@<a href="#_sub1" class="code" title="subfunction f = integrate_network_der(t,s_int,network,internal,external,s_ext,N_int,verbose_flag)">integrate_network_der</a>,T,s_int,odeoptions,network,<span class="keyword">...</span>
0115                             internal,external,s_ext,N_int,verbose_flag);
0116      <span class="keyword">end</span>
0117 
0118 <span class="keyword">end</span>
0119  
0120 s_int_t         = s_int_t';
0121 s_t             = ones(n_S,length(t)); 
0122 s_t(internal,:) = s_int_t; 
0123 
0124 <span class="keyword">if</span> length(external), s_t(external,:) = repmat(s_ext,1,length(t)); <span class="keyword">end</span>
0125 
0126 <span class="keyword">if</span> ~isempty(ind_assignment),
0127   <span class="keyword">for</span> it = 1:length(t),
0128     this_s = s_t(:,it);
0129     [this_assignment,ddd] = feval(network.kinetics.assignment_function,this_s,network.kinetics.parameters);
0130     ii = <a href="../.././mnt/utils/label_names.html" class="code" title="function [label,indices] = label_names(names,allnames,method)">label_names</a>(ddd,network.metabolites); ii = ii(find(ii));
0131     s_t(ind_assignment,it) = this_assignment(ii);
0132    <span class="keyword">end</span>
0133 <span class="keyword">end</span>
0134  
0135 met_int = network.metabolites(internal);
0136 
0137 <span class="comment">%% --------------------------------------------------------------------</span>
0138 <span class="comment">%% compute fluxes</span>
0139 
0140 <span class="keyword">if</span> nargout &gt; 4,
0141   
0142   <span class="keyword">switch</span> network.kinetics.type,
0143     
0144     <span class="keyword">case</span> <span class="string">'numeric'</span>,
0145       <span class="keyword">for</span> it=1:length(t),
0146         v(:,it) = feval(network.kinetics.velocity_function,s_t(:,it),network.kinetics.parameters,t(it));
0147       <span class="keyword">end</span>
0148       
0149     <span class="keyword">otherwise</span>,
0150       <span class="keyword">for</span> it=1:length(t),
0151         v(:,it) = <a href="../.././mnt/mnt_kinetics/kinetics/network_velocities.html" class="code" title="function v = network_velocities(s, network, kinetics, split, indices,t)">network_velocities</a>(s_t(:,it),network);
0152       <span class="keyword">end</span>
0153   <span class="keyword">end</span>
0154 
0155   <span class="keyword">if</span> ~isempty(network.kinetics.assignment_function),
0156     <span class="keyword">for</span> it=1:length(t),
0157       x_assign(:,it) = feval(network.kinetics.assignment_function,s_t(:,it),network.kinetics.parameters);
0158     <span class="keyword">end</span>
0159   <span class="keyword">end</span>
0160 
0161 <span class="keyword">end</span>
0162  
0163 <span class="keyword">if</span> length(Tmax),
0164   stop(my_timer);
0165 <span class="keyword">end</span>
0166  
0167 
0168 <span class="comment">% --------------------------------------------------------------------</span>
0169 
0170 <a name="_sub1" href="#_subfunctions" class="code">function f = integrate_network_der(t,s_int,network,internal,external,s_ext,N_int,verbose_flag)</a>
0171 
0172 <span class="comment">%if verbose_flag,</span>
0173 <span class="comment">%  t</span>
0174 <span class="comment">%end</span>
0175 
0176 <span class="comment">% vector f contains time derivative of the internal metabolites</span>
0177 
0178 s(internal)  = s_int;
0179 s(external)  = s_ext;
0180 f            = N_int * <a href="../.././mnt/mnt_kinetics/kinetics/network_velocities.html" class="code" title="function v = network_velocities(s, network, kinetics, split, indices,t)">network_velocities</a>(s,network);
0181 
0182 <span class="comment">% --------------------------------------------------------------------</span>
0183 
0184 <a name="_sub2" href="#_subfunctions" class="code">function f = integrate_network_der_dil(t,s_int,network,internal,external,s_ext,N_int,verbose_flag,dilution_rate)</a>
0185 
0186 <span class="comment">% vector f contains time derivative of the internal metabolites</span>
0187 
0188 s(internal)  = s_int;
0189 s(external)  = s_ext;
0190 f            = N_int * <a href="../.././mnt/mnt_kinetics/kinetics/network_velocities.html" class="code" title="function v = network_velocities(s, network, kinetics, split, indices,t)">network_velocities</a>(s,network) - dilution_rate * s_int;
0191 
0192 <span class="comment">% --------------------------------------------------------------------</span>
0193 
0194 <a name="_sub3" href="#_subfunctions" class="code">function f = integrate_network_der_MA(t,s_int,s_ext,Nf_int,Nb_int,Nk_fwdT,Nk_bwdT)</a>
0195 
0196 <span class="comment">% vector f contains time derivative of the internal metabolites</span>
0197 
0198 log_s_int = log(s_int+10^-14);
0199 f         = Nk_fwdT *  exp(Nf_int' * log_s_int )   -   Nk_bwdT *  exp(Nb_int' * log_s_int);
0200 
0201 <span class="comment">% --------------------------------------------------------------------</span>
0202 
0203 <a name="_sub4" href="#_subfunctions" class="code">function f = timer_error()</a>
0204 
0205 display(<span class="string">'Calculation time exceeded'</span>);
0206 error</pre></div>
<hr><address>Generated on Sun 09-Nov-2014 13:14:25 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>